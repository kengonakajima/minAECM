# AECM版の echobackと cancel_file の実装

本プロジェクトでは、音響エコーキャンセラの実装である AECM を用いた、
エコーキャンセルつきエコーバックプログラム echoback と、
refとrecの2つのWAVファイルを入力してエコー信号をキャンセルするプログラム cancel_file を実装する。

この2つのプログラムは、もともと  ../minAEC  で実装されたものを、コピーしてきたが、まだビルドと実行ができていない。

../minAEC は、WebRTCの最新のエコーキャンセラである AEC3 を大幅に縮小したものを使っている。

しかし本プロジェクトでは、AEC3ではなく、WebRTCの、軽量なエコーキャンセラ実装である、 AECM を用いて、
minAEC と同じように、 echobackと cancel_file を実装する。

minAECの仕様は、 ../minAEC/spec.txt に記述されている。


## 実装の方針

本プロジェクトの目的はエコーキャンセルアルゴリズムの実装をするためなので、
できるだけ、必要不可欠なアルゴリズムそのもの以外の要素を排除したい。
それらはつまり、以下のようなものである:

ボイラープレートや、多プラットフォーム対応、拡張性、柔軟性、
セキュリティ、エラー処理、例外処理、高負荷対策、最高性能の追求、国際化、
再利用性などは一切必要がない。
複数のサンプリング周波数に対応する必要はない。
古いC++(17とか)に対応する必要はない。
macOSだけで動けば良い。
メモリ消費が多くても良い。
実行が遅くても良い。
Apple Siliconの macOS専用でよい。それいがいには一切対応しなくていい。
macOSのバージョンは手元のmacbookだけでいい。
unittestは不要。

音質は、キャンセルができていれば、多少低くて構わない。ただしフィルタは収束して、エコーキャンセルが実際に機能している必要はある。

エコーキャンセルがいったいどのような技術によって支えられているのかの説明ができればよく、それ以外は必要がない。
モノラルで十分、16KHz固定でOK,マルチチャネル不要、
拡張性不要、柔軟性不要。
教育目的に必要ない機能自体を削除し、結果としてコード量を削減する。

型を固定することでテンプレートの利用も削減したい。
テンプレートはエコーキャンセルの仕組みを説明するためには不要。
デバッグ用の機能も不要。

安全性のための機能も不要。
とにかくエコーキャンセルの根本的な仕組みを解説するため以外のコード部分は一切不要。
ソースを1行でも減らす。


## 残したいところ
以下の部分は残したい。

自走できるエコーキャンセラを実装したいので、
また、PortAudioを用いて実際に動かして試せることも必須。
それ以外の要素はすべて必要がない。
ライブラリとして利用する必要がないので、いろいろなオブジェクトを複数生成したり破棄したりする必要もない。
サンプルは一度動けば良い。
複数スレッドに対応する必要もない。

## 作業内容

Makefileを修正し、 make一発で echobackと cancel_fileがコンパイルされること。

それを私が実行して、実際に耳で音を聞いて音質を確認します。

## 残す部分
教育用に、 --passthrough オプションは必要。



## さらなるコード削減に向けて


 【優先度提案（上から順に）】

      1. 近端クリーン経路削除＋FFT分岐削除＋未使用定数/メンバ削除（低リスクで短縮効果大）
      2. ダイナミックQ固定化＋ABS近似/√のどちらか片側固定（依存削減）
      3. robust validationの物理削除（遅延推定の中身を軽量化）
      4. エコーモード/遅延パラメータの固定化（API面もスリムに）
      5. スペクトル遅延推定の撤去（最小構成への到達）

  - 16kHz前提の条件分岐除去
      - すでに 16kHz/モノラル/160サンプル固定なので、aecm_core{,_c}.cc の mult==2 前提分岐を前提化して残る片側だけ
  にする。
      - echo_control_mobile.cc の NB/WB分岐コメント・i==1チェックなど、WB前提でロジックを簡素化。
  - バッファアラインメントの簡素化
      - NEON用の「+16/+32 バイトマージン」配列とポインタ再配置を削除し、素直な配列参照に（aecm_core.h,
  aecm_core.cc, aecm_core_c.cc）。Apple SiliconでもC実装のみで支障なし。
      - Aecm_set_config() と AecmConfig を廃し、Aecm_Init() 内で echoMode=3 固定。呼び出し元（echoback.cc,
  cancel_file.cc）の設定コードを削除。
      - 影響: 学習用途では十分。可変モードは不要。

  - signal_processing_library.h の必要最小限化
      - AECMが実際に使う関数/マクロ（NormW16/NormW32/NormU32/AddSat/SubSat/DivW32W16/DivU32U16/SHIFT/SAT/MUL_* な
  ど）だけを抽出し、ヘッダ内の未使用宣言と関連C実装（min_max_operations.c, division_operations.c, spl_sqrt_floor.c
  など）の未使用部分を削る。
  - ComplexBitReverse の固定オーダ最適化
      - 本プロジェクトは order=7（PART_LEN=64）固定なので、complex_bit_reverse.c を order固定のテーブル1つに縮約可能。
